#!/bin/bash
 

source /home/marie/.bashrc
source /usr/local/gromacs/bin/GMXRC
export GMXLIB=/home/marie/Utilities/gromacs-2020/pmx/data/mutff45

gmx -quiet grompp -f min -c  ions.pdb -p  topol.top -maxwarn 1  -o  topol.tpr
gmx -quiet  mdrun -gpu_id $1 -v -c em.pdb ;

gmx -quiet grompp -f eq.mdp -c em.pdb -p topol.top -o eq.tpr  -maxwarn 1 ;
gmx -quiet mdrun -gpu_id $1 -s eq.tpr -v -nt 2 -nice 0 -c eq.gro  -ntmpi 1;

if test -f eq.gro ; then echo "So far so good..."; else echo "Need a more gentle equilibration " ; gmx grompp -f eq-1fs.mdp -c em.pdb -p topol.top -o eq-1fs.tpr ; gmx mdrun -s eq-1fs.tpr -v -nt 2 -nice 0 -c eq.gro  -ntmpi 1; gmx grompp -f eq.mdp -c em.pdb -p topol.top -o eq.tpr ; gmx mdrun -s eq.tpr -v -nt 2 -nice 0 -c eq.gro  -ntmpi 1;  fi

gmx -quiet grompp -f equi.mdp -c eq.gro -p topol.top -o eq.tpr -maxwarn 1 ;
gmx -quiet mdrun -gpu_id $1 -s eq.tpr -v -nt 2 -nice 0 -c equi1.gro  -ntmpi 1;

gmx -quiet grompp -f equi2.mdp -c equi1.gro -p topol.top -o eq.tpr -maxwarn 1 ;
gmx -quiet mdrun -gpu_id $1 -s eq.tpr -v -nt 2 -nice 0 -c equi2.gro  -ntmpi 1;

gmx -quiet grompp -f prod_000.mdp -c eq.gro -p topol.top -o md.tpr  -maxwarn 1;
gmx -quiet mdrun -gpu_id $1 -s md.tpr -v -nt 2 -nice 0 -c md.gro -ntmpi 1;


echo 'sys' | gmx trjconv -s topol.tpr  -o sample.pdb -ur compact -pbc mol -split 1 ;

for i in {1..80} ; do mkdir $i ; cd $i ; mv ../sample$i\.pdb .; gmx grompp -f ../fastgrowth.mdp -c sample$i\.pdb -p ../topol.top -maxwarn 1 ; 
gmx -quiet mdrun -gpu_id $1 -v -nt 2 -nice 0 -c mdfg.gro -ntmpi 1 ; cd - ; done 

echo 'DONE' >  mutation.log
